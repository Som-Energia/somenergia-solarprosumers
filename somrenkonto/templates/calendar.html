{% extends 'somsolet/base_layout.html' %}
{% load static %}
{% load i18n %}

{% get_current_language as LANGUAGE_CODE %}
{% get_language_info for LANGUAGE_CODE as lang %}

{% get_available_languages as LANGUAGES %}
{% get_language_info_list for LANGUAGES as languages %}


{% block css %}
    <link href="{% static 'autocomplete/autoComplete.min.css' %}" rel='stylesheet'/>
    {{ block.super }}
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker.css" type="text/css" media="all" rel="stylesheet">
    <link href="{% static 'fullcalendar/lib/main.min.css' %}" rel='stylesheet'/>
{% endblock %}

{% block content %}
<div class="row">
  <div id="calendar" class="col">
  </div>
  <div id="event-form" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <form>
                <div class="modal-header">
                    <input class="form-control form-control-lg" type="text" placeholder="{% trans 'Title of the event' %}">
                </div>
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group col form-check btn-group-toggle" data-toggle="buttons">
                            <label class="btn btn-primary btn-block ">
                                <input type="radio" id="inlineCheckbox1" value="option1" name="event_type" autocomplete="off">{% trans "Appointment" %}
                            </label>
                            <label class="btn btn-primary btn-block">
                                <input type="radio" id="inlineCheckbox2" value="option2" name="event_type" autocomplete="off">{% trans "Unavailability" %}
                            </label>
                            <label class="btn btn-primary btn-block">
                                <input type="radio" id="inlineCheckbox3" value="option3" name="event_type" autocomplete="off">{% trans "Availability hours" %}
                            </label>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col">
                            <input id="initial_date_picker" class="form-control form-control-sm" type="text" placeholder="{% trans 'Initial date' %}">
                        </div>
                        <div class="form-group col">
                            <input id="final_date_picker" class="form-control form-control-sm" type="text" placeholder="{% trans 'Final date' %}">
                        </div>
                    </div>
                    <div class="form-row collapse" id="event_hours">
                        <div class="form-group col">
                            <input id="initial_hour_picker" class="form-control form-control-sm" type="text" placeholder="{% trans 'Initial hour' %}">
                        </div>
                        <div class="form-group col">
                            <input id="final_hour_picker" class="form-control form-control-sm" type="text" placeholder="{% trans 'Final hour' %}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="switch_event_hours">
                                <label class="custom-control-label" for="switch_event_hours">{% trans 'All day' %}</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col">
                            <input  class="form-control form-control-sm" id="campaings_id" type="text" tabindex="1" placeholder="{% trans 'Campaing' %}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col">
                            <input  class="form-control form-control-sm" id="installations_id" type="text" placeholder="{% trans 'Installation' %}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col">
                            <textarea class="form-control" rows="3" placeholder="{% trans 'Description' %}"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">{% trans 'Close' %} </button>
                    <button type="button" class="btn btn-primary">{% trans 'Save changes' %}</button>
                </div>
            </form>
        </div>
    </div>
  </div>
</div>

{% endblock content %}

{% block js %}
    {{ block.super }}
    <script src="{% static 'fullcalendar/lib/main.min.js' %}"></script>
    {% for language in languages %}
         <script src="{% static 'fullcalendar/lib/locales/{{languages.code}}.js' %}"></script>
    {% endfor %}

    <script src="{% static 'autocomplete/autoComplete.min.js' %}"></script>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/js/bootstrap-datetimepicker.min.js"></script>
    <script type="text/javascript">

     function set_selection_value(element, value) {
         document.querySelector(element).value = value;
         document
			       .querySelector("#campaings_id")
			       .setAttribute("placeholder", value);
     }

     const autocomplete_campaing = new autoComplete({
         data: {
             key: ['name'],
             cache: true,
             src: [
                 {
                     name: 'Infierno Solar'
                 },
                 {
                     name: 'Sol i Sol'
                 }
             ]
         },
         placeHolder: "{% trans 'Type to search a campaing' %}",
         selector: '#campaings_id',
         threshold: 1,
         searchEngine: 'loose',
         resultsList: {
             render: true,
             container: function(source) {
                 source.setAttribute("class", "autoComplete_resultlist");
                 source.setAttribute("id", "campaings_resultlist");
             },
             destination: document.querySelector("#campaings_id"),
             position: "afterend",
             element: "ul"
         },
         resultItem: {
             content: function(data, source) {
                 source.innerHTML = data.match;
             },
             element: "li"
         },
         highlight: true,
         onSelection: function(feedback) {
             set_selection_value('#campaings_id', feedback.selection.value.name);
         }
     });

     const autocomplete_installation = new autoComplete({
         data: {
             key: ['name'],
             cache: true,
             src: [
                 {
                     name: 'Dolores se llamaba Lola'
                 },
                 {
                     name: 'Sebastien pinya'
                 }
             ]
         },
         placeHolder: "{% trans 'Type to search a campaing' %}",
         selector: '#installations_id',
         threshold: 1,
         searchEngine: 'loose',
         resultsList: {
             render: true,
             container: function(source) {
                 source.setAttribute("class", "autoComplete_resultlist");
                 source.setAttribute("id", "installations_resultlist");
             },
             destination: document.querySelector("#installations_id"),
             position: "afterend",
             element: "ul"
         },
         resultItem: {
             content: function(data, source) {
                 console.log(data);
                 console.log(source);
                 source.innerHTML = data.match;
             },
             element: "li"
         },
         highlight: true,
         onSelection: function(feedback) {
             set_selection_value('#installations_id', feedback.selection.value.name);
         }
     });
    </script>

    <script type="text/javascript">
        function initialize_datepickers() {
            $('#initial_date_picker').datetimepicker({
                format: 'L',
                locale: '{{ lang.code|default:'ca'}}',
                useCurrent: false
            });
            $('#initial_hour_picker').datetimepicker({
                format: 'LT',
                locale: '{{ lang.code|default:'ca'}}',
                useCurrent: false
            });
            $('#final_date_picker').datetimepicker({
                format: 'L',
                locale: '{{ lang.code|default:'ca'}}',
                useCurrent: false
            });
            $('#final_hour_picker').datetimepicker({
                format: 'LT',
                locale: '{{ lang.code|default:'ca'}}',
                useCurrent: false
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                themeSystem: 'bootstrap',
                customButtons: {
                    configureCalendar: {
                        text: 'Configuration',
                        icon: 'fa-cogs'
                    }
                },
                bootstrapFontAwesome: {
                    configureCalendar: 'fa-cogs'
                },
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay configureCalendar'
                },
                locale: '{{ lang.code|default:'ca'}}',
                firstDay: 1,
                initialView: 'dayGridMonth',
                aspectRatio:2,
                selectable: true,
                editable: true,
                unselectAuto: false,
                navLinks: true,
                nowIndicator:true,
                businessHours: [
                    {
                        daysOfWeek: [ 1, 2, 3 ], // Monday, Tuesday, Wednesday
                        startTime: '08:00', // 8am
                        endTime: '18:00' // 6pm
                    }
                ],
                dateClick: function(info) {
                    var eventFormModal = $('#event-form');
                    var initial_date_picker = $('#initial_date_picker');
                    var initial_hour_picker = $('#initial_hour_picker');
                    var final_date_picker = $('#final_date_picker');
                    var final_hour_picker = $('#final_hour_picker');
                    var event_hours = $('#event_hours');
                    var switch_event_hours = document.getElementById('switch_event_hours');

                    if (info.allDay) {
                        event_hours.collapse('hide');
                        switch_event_hours.checked = true;

                    } else {
                        event_hours.collapse('show');
                        switch_event_hours.checked = false;
                    }
                    initial_date_picker.data("DateTimePicker").clear();
                    initial_hour_picker.data("DateTimePicker").clear();
                    final_date_picker.data("DateTimePicker").clear();
                    final_hour_picker.data("DateTimePicker").clear();

                    initial_date_picker.data("DateTimePicker").date(info.date);
                    initial_hour_picker.data("DateTimePicker").date(info.date);
                    final_date_picker.data("DateTimePicker").minDate(info.date);
                    final_date_picker.data("DateTimePicker").date(info.date);

                    eventFormModal.modal('show');

                    initial_date_picker.on('dp.change', function(data) {
                        final_date_picker.data("DateTimePicker").minDate(data.date);
                    });
                    final_date_picker.on('dp.change', function(data) {
                        initial_date_picker.data("DateTimePicker").maxDate(data.date);
                        final_hour_picker.data("DateTimePicker").minDate(false);
                    });

                    initial_hour_picker.on('dp.change', function(data) {
                        final_hour_picker.data("DateTimePicker").minDate(data.date);
                    });
                },
                select: function(info){
                    var eventFormModal = $('#event-form');
                    var initial_date_picker = $('#initial_date_picker');
                    var initial_hour_picker = $('#initial_hour_picker');
                    var final_date_picker = $('#final_date_picker');
                    var final_hour_picker = $('#final_hour_picker');
                    var event_hours = $('#event_hours');
                    var switch_event_hours = document.getElementById('switch_event_hours');
                    var final_datetime;

                    if (info.allDay) {
                        event_hours.collapse('hide');
                        switch_event_hours.checked = true;
                        final_datetime = moment(info.endStr).subtract(1, 'days');
                    } else {
                        event_hours.collapse('show');
                        switch_event_hours.checked = false;
                        final_datetime = info.end
                    }
                    initial_date_picker.data("DateTimePicker").clear();
                    initial_hour_picker.data("DateTimePicker").clear();
                    final_date_picker.data("DateTimePicker").clear();
                    final_hour_picker.data("DateTimePicker").clear();

                    initial_date_picker.data("DateTimePicker").date(info.start);
                    initial_hour_picker.data("DateTimePicker").date(info.start);
                    final_date_picker.data("DateTimePicker").minDate(info.start);
                    final_date_picker.data("DateTimePicker").date(final_datetime);
                    final_hour_picker.data("DateTimePicker").date(final_datetime);

                    eventFormModal.modal('show');
                }
            });
            calendar.render();
        });
        initialize_datepickers();

        var switch_event_hours = $('#switch_event_hours');
        switch_event_hours.on('click', function(){
            var event_hours = $('#event_hours');
            event_hours.collapse('toggle');
        });

    </script>
{% endblock %}
