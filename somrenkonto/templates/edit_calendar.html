{% extends 'somsolet/base_layout.html' %}
{% load static %}
{% load i18n %}

{% get_current_language as LANGUAGE_CODE %}
{% get_language_info for LANGUAGE_CODE as lang %}

{% block css%}
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker.css" type="text/css" media="all" rel="stylesheet">
    {{ block.super }}
{% endblock%}

{% block content %}
<div class="row p-5 m-5">
    <form class="form" action="{% url 'edit_calendar' calendar_config.calendar.id %}" method="post">
        {% csrf_token %}

        <div class="row mb-2">
            <div class="col">
                <h3>
                    {% trans 'Visualization options' %} <br>
                    <small class="text-muted">{% trans 'How do you want to see your calendar?' %}</small>
                </h3>
                <div class="form-group">
                    <select class="form-control" id="{{ config_form.default_calendar_view.id_for_label }}">
                        {% for option_view in config_form.fields.default_calendar_view.choices %}
                        <option value={{ option_view.1}} name="{{ config_form.default_calendar_view.html_name }}"> {{option_view.0 }}</option>
                        {% endfor %}
                    </select>
                  </div>
            </div>
        </div>

        <div class="row mb-2">
            <div class="col mb-2">
                <h3>
                    {% trans 'Business Hours' %} <br>
                    <small class="text-muted">{% trans 'Define when you are available' %}</small>
                </h3>
                <div class="form-group">
                    {% for working_day in config_form.working_days.field.choices %}
                    <div class="form-row business-day-row">
                        <div class="form-group col-3 form-check btn-group-toggle" data-toggle="buttons" data-target="date-{{ forloop.counter }}" data-name="business-day-button">
                            <label class="btn btn-primary btn-block ">
                                <input type="checkbox" id="{{ config_form.working_days.id_for_label}}" value="{{ working_day.0 }}" name="{{ config_form.working_days.html_name}}" autocomplete="off">{{ working_day.1 }}
                            </label>
                        </div>
                        <div id="date-{{ forloop.counter }}" class="col business-day-available-hour ml-5 collapse">
                            <input id="" class="form-control form-control-sm mr-2" type="text" name="" data-name="business-day-initial-hour" timepicker-target="picker-{{ forloop.counter }}" placeholder="{% trans 'Initial hour' %}" autocomplete="off">
                            
                            <i class="fa fa-long-arrow-right" aria-hidden="true"></i>
                            
                            <input id="picker-{{ forloop.counter }}" class="form-control form-control-sm ml-2" type="text" name="" data-name="business-day-final-hour" placeholder="{% trans 'Final hour' %}" autocomplete="off">
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="row mb-2">
            <div class="col">
                <div class="form-group">
                    <a type="button" class="btn btn-secondary" href="{{ request.META.HTTP_REFERER }}">{% trans 'Back' %} </a>
                    <button type="button submit" class="btn btn-primary">{% trans 'Save' %}</button>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock content %}

{% block js %}
    {{ block.super }}
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/js/bootstrap-datetimepicker.min.js"></script>

    <script type="text/javascript">
        function setCollapaseInAvailableHours(businessDayChecks) {
            for (let businessDay of businessDayChecks) {
                $(businessDay).click(function(elem) {
                    let target = $(elem.currentTarget).attr('data-target');
                    $('#'+target).collapse('toggle');
                });
            }
        }

        var businessDayChecks = $('[data-name="business-day-button"]');
        setCollapaseInAvailableHours(businessDayChecks);
    </script>
    <script type="text/javascript">
        var initialHourTimePickers = $('[data-name="business-day-initial-hour"]');
        var finalHourTimePickers = $('[data-name="business-day-final-hour"]');

        var base_config = {
            format: 'LT',
            locale: '{{ lang.code|default:'ca'}}',
            useCurrent: true,
            icons: {
                up: 'fa fa-chevron-up icon-green',
                down: 'fa fa-chevron-down icon-green'
            }
        }

        function initBusinessDayTimePickers(initialHourTimePicker, finalHourTimePickers) {
            for (let initialHourTime of initialHourTimePickers) {
                let initialHourTimePicker = $(initialHourTime); 
                initialHourTimePicker.datetimepicker(base_config);

                initialHourTimePicker.on('dp.change', function(data) {
                    let finalHourTimePicker = $('#' + $(data.currentTarget).attr('timepicker-target'));
                    finalHourTimePicker.data("DateTimePicker").minDate(data.date);
                });
            }
            for (let finallHourTime of finalHourTimePickers) {
                $(finallHourTime).datetimepicker(base_config)
            }
        }
        initBusinessDayTimePickers(initialHourTimePickers, finalHourTimePickers);

    </script>
{% endblock %}